const WebSocket=require("ws"),colors=require("colors"),axios=require("axios"),path=require("path"),fs=require("fs"),{HttpsProxyAgent:HttpsProxyAgent}=require("https-proxy-agent");function rest(e){return new Promise((e=>setTimeout(e,1e3)))}class Cowtopia{constructor(e,t,o){this.query=e,this.proxy=new HttpsProxyAgent(t),this.index=o,this.init()}async gameInfo(){return axios.get("https://cowtopia-be.tonfarmer.com/user/game-info",{headers:{accept:"application/json, text/plain, */*","accept-language":"en-US,en;q=0.9",authorization:`Bearer ${this.token}`,"if-none-match":'W/"6ce-lt72biKxsubGeNMaYYhhVTvvRLY"',origin:"https://cowtopia-prod.tonfarmer.com",priority:"u=1, i",referer:"https://cowtopia-prod.tonfarmer.com/","sec-ch-ua":'"Chromium";v="128", "Not;A=Brand";v="24", "Brave";v="128"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"macOS"',"sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"same-site","sec-gpc":"1","user-agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36","x-chain-id":"43113","x-lang":"en","x-os":"miniapp"},httpsAgent:this.proxy})}autoUpgrade(){setInterval((async()=>{try{await this.auth();const e=(await this.gameInfo()).data.data.factories;for(const t of e)t.animal_count<5&&this.ws.send(`42["buy-animal",{"factory_id":"${t.factory_id}"}]`);this.ws.send('42["buy-factory"]'),this.log(colors.green("Trigger upgrade factory"));const t="https://cowtopia-be.tonfarmer.com/factory/upgrade-house",o={accept:"application/json, text/plain, */*","accept-language":"en-US,en;q=0.9",authorization:`Bearer ${this.token}`,"content-type":"application/json",origin:"https://cowtopia-prod.tonfarmer.com",priority:"u=1, i",referer:"https://cowtopia-prod.tonfarmer.com/","sec-ch-ua":'"Chromium";v="128", "Not;A=Brand";v="24", "Brave";v="128"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"macOS"',"sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"same-site","sec-gpc":"1","user-agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36","x-chain-id":"43113","x-lang":"en","x-os":"miniapp"},s={};await axios.post(t,s,{headers:o,httpsAgent:this.proxy}),this.log(colors.green("Trigger upgrade house"))}catch(e){this.log(colors.red(`Upgrade error: ${e.message}`))}}),36e5)}keepOnline(){setInterval((()=>{try{this.log(colors.green("Sell product")),this.ws.send('42["sell-product",{}]')}catch(e){this.log(colors.red("Sell product error",e))}}),1e4)}log(e){console.log(`[*] Account ${this.index} :  ${e}`)}parseJson=e=>{try{return JSON.parse(e)}catch(e){return this.log(colors.red("Failed to parse JSON:",e)),{}}};async auth(){const e=await axios.post("https://cowtopia-be.tonfarmer.com/auth",{},{headers:{accept:"application/json, text/plain, */*","accept-language":"en-US,en;q=0.9","content-type":"application/json",origin:"https://cowtopia-prod.tonfarmer.com",priority:"u=1, i",referer:"https://cowtopia-prod.tonfarmer.com/","sec-ch-ua":'"Chromium";v="128", "Not;A=Brand";v="24", "Brave";v="128"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"macOS"',"sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"same-site","sec-gpc":"1","user-agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36","x-chain-id":"43113","x-lang":"en","x-os":"miniapp","x-tg-data":this.query},httpsAgent:this.proxy});this.token=e.data.data.access_token}async init(){await this.auth(),this.connectSocket(),this.keepOnline(),this.autoUpgrade(),this.autoCompleteAllMissions()}async getMission(e){return axios.get(`https://cowtopia-be.tonfarmer.com/mission?group=${e}`,{headers:{accept:"application/json, text/plain, */*","accept-language":"en-US,en;q=0.9",authorization:`Bearer ${this.token}`,"if-none-match":'W/"1b31-WwHE4Bv623KfvswTIeUh1UbxM+k"',origin:"https://cowtopia-prod.tonfarmer.com",priority:"u=1, i",referer:"https://cowtopia-prod.tonfarmer.com/","sec-ch-ua":'"Chromium";v="128", "Not;A=Brand";v="24", "Brave";v="128"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"macOS"',"sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"same-site","sec-gpc":"1","user-agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36","x-chain-id":"43113","x-lang":"en","x-os":"miniapp"},httpsAgent:this.proxy})}async autoCompleteAllMissions(){setInterval((async()=>{try{let e=await this.getMission("bot"),t=e.data.data.missions;for(const e of t)"no_action"!==e.action||e.completed||(this.ws.send(`42["check-mission",{"mission_key":"${e.key}"}]`),this.log(colors.green(`Trigger complete main  mission: ${e.key}`))),await rest(1);e=await this.getMission("partner"),t=e.data.data.missions;for(const e of t)"no_action"!==e.action||e.completed||(this.ws.send(`42["check-mission",{"mission_key":"${e.key}"}]`),this.log(colors.green(`Trigger complete partner  mission: ${e.key}`))),await rest(1)}catch(e){this.log(colors.red(`Trigger complete daily error: ${e.message}`))}}),216e5)}connectSocket(){this.ws=new WebSocket("wss://cowtopia-ws.tonfarmer.com/socket.io/?EIO=4&transport=websocket",{agent:this.proxy}),this.ws.on("open",(()=>{this.log(colors.green("Connected"));const e=`40{"token":"${this.token}"}`;this.ws.send(e)})),this.ws.on("message",(e=>{const t=e.toString(),o=t.match(/^(\d+)(.*)$/);if(o){const e=o[1];o[2];this.handleMessage(e,t)}else this.log(colors.yellow("Message format not recognized.",t))})),this.ws.on("close",(()=>{this.log(colors.yellow("WebSocket connection closed. Will reopen")),this.init()})),this.ws.on("error",(e=>{console.error("WebSocket error:",e),this.init()}))}handleMessage(e,t){if("2"===e)this.ws.send("3");else this.log(colors.blue(`Receive prefix ${e}`))}}function bot(){const e=path.join(__dirname,"query.txt"),t=fs.readFileSync(e,"utf8").trim().split("\n"),o=path.join(__dirname,"proxy.txt"),s=fs.readFileSync(o,"utf8").trim().split("\n");for(let e=0;e<t.length;e++){const o=s[e%s.length];new Cowtopia(t[e],o,e)}}bot();